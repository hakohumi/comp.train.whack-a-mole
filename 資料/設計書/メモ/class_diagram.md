# 機能説明

## 変数

### グローバル

- スイッチチャタ状態

### ローカル

- main
  - スイッチ入力状態

  - ゲーム前
    - 画面状態
  - ゲーム中
    - 制限時間
    - スコア
  - ゲーム後

### EEPROM

- ハイスコア
  - Easy
  - Normal
  - Hard

## main

- テンプレート

- 説明
- 前提条件
- 呼ばれるトリガー
- 処理

### モグラ

- モグラの状態
  - 穴
  - 出現中
  - 撃退

- 「モグラx表示時間」
  - モグラが表示されている時間
  - モグラが出現している時と、モグラが撃退され、消えるまでの時間を保持する。
  - タイマで時間を減少させる。

####　PopDecision モグラ出現判定関数

- 説明
  - 割込みで、モグラ出現判定フラグがtrueの時に実行
  - 入力によって、ランダム関数と演算し確率を出す。
  - 残り制限時間が少なくなるほど、確率があがるようにする。
- 引数：
  - 残り制限時間

- 戻り値：
  - bool 出現した、していない

#### OutOfHole

- 説明
  - 前提条件
    - PoPDesicionがtrueの時、呼ばれる。
  - トリガー
    - モグラの状態更新処理で前提条件を満たした時
  - 処理：
    - モグラの状態を出現に変更する。
    - モグラの表示時間を設定する（モグラ表示時間設定関数を用いる）

- 引数
  - void
- 戻り値
  - void

#### モグラ表示時間設定関数

- 説明
  - モグラの出現時・撃退時の表示時間を設定する関数
- 処理：
  - 入力された残り制限時間によって、出力されるモグラの表示時間を少なくする。
- 引数：
  - uint8_t 残り制限時間
- 戻り値
  - uint8_t モグラの表示時間

#### DoNothing

- 説明
  - 前提条件：
    - モグラの状態が「出現中」、「撃退」の場合に呼ばれる関数
  - 処理：
    - モグラ表示時間を減少させる。

#### BackToHole

- 説明
  - 前提条件：
    - モグラの状態が「出現中」、「撃退」の場合にのみ呼ばれる。
  - 呼ばれるトリガー：
    - モグラ表示時間が0になった場合
  - 処理：
    - モグラの状態を「穴」に変更する。

#### Attacked

- 説明
  - モグラが撃退された

  - 前提条件
    - モグラの状態が「出現中」の場合にのみ
  - 呼ばれるトリガー
    - 前提条件の時、対応したスイッチが押されていることを検知した
  - 処理
    - モグラの状態を「撃退」へ変更
    - スコアを増加させる

### Timer

#### Penalty

- 説明
  - お手付き処理
- 前提条件
  - モグラの状態が「穴」の時
- 呼ばれるトリガー
  - 前提条件の時、対応したスイッチが押されていることを検知した
- 処理
  - 残り制限時間を3秒減少させる。

### Score

#### IncScore

- 説明
  - スコアを増加させる
- 前提条件
  - モグラの状態が「出現中」の場合にのみ
- 呼ばれるトリガー
  - Attackedが呼ばれた時
- 処理
  - スコアを1増加させる

#### SaveHighScore

- 説明
  - ハイスコアを記録する
- 前提条件
  - システム状態が「ゲーム後」
- 呼ばれるトリガー
  - 前提条件の時、スコアがハイスコアより高い場合
- 処理
  - EEPROMにハイスコアを格納する

#### ClearHighScore

- 説明
  - ハイスコアをクリアする
- 前提条件
  - システム状態が「ゲーム前」、画面状態が「HSクリア確認画面」の時
- 呼ばれるトリガー
  - スイッチ1が入力された
- 処理
  - 選択された難易度に合わせたハイスコアの値として0をEEPROMに書きこむ。

- 引数
  - 難易度
- 戻り値

### Level

#### SetLevel

- 説明
  - 難易度を設定する
- 前提条件
  - システム状態が「ゲーム前」の時
  - 画面状態が「難易度選択画面」の時
- 呼ばれるトリガー
  - スイッチ1 → Easy
  - スイッチ2 → Normal
  - スイッチ3 → Hard
- 処理
  - 難易度を変更
  - 難易度の画面をバッファへ書き込み（WriteToBuffer）

### State

#### 状態_全体

- 説明
  - システム全体の状態
- 状態の種類
  - ゲーム前
  - ゲーム中
  - ゲーム後

#### 画面状態

- 説明
  - 画面の状態
- 種類
  - タイトル画面
  - 難易度選択画面
  - HSクリア確認画面
  - ゲーム開始カウントダウン画面
  - ゲーム中画面
  - リザルト画面

#### ChangeState関数

- 説明
  - システム全体の状態を変更する
  - 状態が変わる時に、呼ばれる
- 引数
  - 状態_全体
- 戻り値
  - void

### LCD

- 説明
  - LCDの画面は、各システムの状態に合わせて、一定間隔でバッファを書き込み、更新する。
  - ゲーム前の画面更新間隔
    - 100ms（10fps）
  - ゲーム中の画面更新間隔
    - 50ms（20fps）

#### WindowManager

- 説明
  - 各画面状態ごとのフォーマットに合わせて、バッファに書き込む
  - 画面更新の間隔を制御する
- 前提条件
  - 各システム状態ごとの画面更新間隔の時間が経つ（フラグが経つ）
- 呼ばれるトリガー
  - 各システム状態の最後の処理
- 処理
  - 画面状態に合わせて、必要な値を取得し、フォーマットを作成する。
  - 各画面状態ごとにフォーマット通りにバッファに文字列を書き込む。（WriteToBuffer）

#### WriteToBuffer

- 説明
  - バッファに文字列を書きこむ。
  - バッファに書き込み、フラグを立たせる。
- 前提条件
  - なし
- 呼ばれるトリガー
  - なし
- 処理
  - 引数
    - 書き込む文字列
  - 戻り値
    - エラー値

#### BufferToLCD

- 説明
  - バッファに書き込み、フラグが立った時のみ、LCDへバッファを書き込む。
  - 書き込んだら、フラグを下げる。
- 前提条件
  - アップデートフラグが立っている時
- 呼ばれるトリガー
  - メインの最後に呼ばれる。
- 処理
  - バッファをLCDへ書き込む。

### Buzzer

- 説明
  - BGMと効果音の2種類がある。
    - BGM
      - システム状態がゲーム中の時、常時曲をループ再生させる。
    - 効果音
      - ゲームが始まる時やモグラを叩いた時など、あるタイミングで決まったパターンのメロディを再生する。あるタイミングは仕様書の概要シートに記載。
      - BGMが流れていた場合、BGMを消音し、効果音を再生した後、再生した分の長さが経過した地点からBGMを再生する。
      - 効果音が鳴っている最中に再度PlaySEが呼ばれた時、一度効果音を停止し、呼ばれた効果音を最初から再生する。

#### PlayBGM

- 説明
  - BGMを再生する。
  - 鳴動パターンは予め設定する。
- 前提条件
  - BGMが再生されていない。
- 呼ばれるトリガー
  - ゲーム開始時
- 処理
  - PWMを開始し、BGMを最初から再生させる。
  - 楽譜に合わせて、PWMをONにする長さとデューティ比を変更する。

#### StopBGM

- 説明
  - BGMを止める
- 前提条件
  - BGMが再生されている。
- 呼ばれるトリガー
  - ゲーム終了時
- 処理
  - PWMを停止させる。

#### PlaySE

- 説明
  - 効果音を再生する
  - 再生パターンは予め設定する
- 前提条件
  - なし
- 呼ばれるトリガー
    - 再生するタイミングの詳細は仕様書の概要シートに記載
- 処理
  - PWMを開始し、効果音を最初から再生する。
  - 引数
    - 鳴らす効果音の番号（uint8_t）
  - 戻り値
    - void

#### StopSE

- 説明
  - 効果音を停止させる。
- 前提条件
  - 効果音が再生している時
- 呼ばれるトリガー
  - 効果音が最後まで再生された時
- 処理
  - 効果音を止める。

## Interrupt

- 10msタイマを使用
- 割込み内でチャタリングを行う。

### Input

#### SW入力

- 説明
  - ポーリングで、すべてのポートからスイッチの状態を取得する。
  - エッジ検知する。

- 使用する変数
  - SWChattaState_type SWChattaState
    - 説明
      - 割込み内にて、静的なローカル変数として定義する。
      - チャタ結果を、メインでグローバル変数で保持している変数に格納する。
    - bool 取得値
    - bool 前回の取得値
    - bool チャタリング処理回数

  - bool[5] SWState
    - 説明
      - メイン関数にて、グローバル変数として定義する。
      - 割込み内でチャタ処理をしたスイッチ入力を保持する変数。
      - bool 確定値

### モグラ出現判定フラグ

- 説明：100msごとなどで、フラグを立てて、メイン関数で判定を行う
  - 使用箇所
    - ゲーム中

### カウントダウン用タイマ

- 説明
  - カウントダウン用に1sが必要
  - 1sのタイミングで、制限時間カウントダウン関数を呼ぶ。




``` mermaid

classDiagram

    class Mole{
        + uint8_t DisplayTime
        + uint8_t enum State
        + bool PoPDecisionFlag

        + OutObHole()
        + DoNothing()
        + BackToHole()
        + Attacked()
        - mole_setState(uint8_t enum) 状態遷移処理
        - mole_reduceDisplayTime() 表示時間の減少
        - mole_determineaApearance() モグラの出現を判定する

    }

    class Score{
        + uint8_t Score
    }

    class 10msTime{
        + uint8_t 1sTimerFlag
    }

    class Input{
        + SWState1
        + SWState2
        + SWState3
        + SWState4
        + SWState5
    }


```