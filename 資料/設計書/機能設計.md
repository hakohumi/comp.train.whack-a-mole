# 機能説明

## 変数

### グローバル

- スイッチチャタ状態
- 制限時間

- main
  - スイッチ入力状態

  - 画面状態定数
    enum DisplayState_type DisplayState
    - 説明
      - 画面の状態を表すenum定数。
    - 画面状態の種類
      - TITLE(タイトル)
      - LEVEL_SELECT(難易度選択)
      - HS_CLEAR(HSクリア確認)
      - START_COUNT_DOWN(ゲーム開始カウントダウン)
      - PLAYING_GAME(ゲーム中)
      - RESULT(リザルト)

  - アクション定数
    enum ActionState_type ActionState
    - 説明
      - 状態遷移図におけるentryアクションとdoアクティビティを表すenum定数。
      - 今回の状態遷移図ではexitアクションがないため省略する。
    - アクションの種類
      - ENTRY(entryアクション)
      - DO(doアクティビティ)

  - システム状態構造体
  SystemState_type SystemState
    - 説明
      - システム全体の状態を管理する構造体。
    - メンバ
      - uint8_t displayState(画面状態)
      - uint8_t actionState(アクション)

- システム状態
  - 画面状態 DisplayState
    - タイトル
    - 難易度選択
    - HSクリア確認
    - ゲーム開始カウントダウン
    - ゲーム中
    - リザルト
  - 状態 ActionState
    - entry
    - do

### ローカル

- main
  - スイッチ入力状態

    - ゲーム前
      - 画面状態
    - ゲーム中
      - スコア
    - ゲーム後

### EEPROM

- ハイスコア
  - Easy
  - Normal
  - Hard

## main機能

- テンプレート

- 説明
- 前提条件
- 呼ばれるトリガー
- 処理

### モグラ

- モグラの状態
  - 穴
  - 出現中
  - 撃退

- 「モグラx表示時間」
  - モグラが表示されている時間
  - モグラが出現している時と、モグラが撃退され、消えるまでの時間を保持する。
  - タイマで時間を減少させる。

####　PopDecision モグラ出現判定関数

- 説明
  - 割込みで、モグラ出現判定フラグがtrueの時に実行
  - 入力によって、ランダム関数と演算し確率を出す。
  - 残り制限時間が少なくなるほど、確率があがるようにする。
- 引数：
  - 残り制限時間

- 戻り値：
  - bool 出現した、していない

#### OutOfHole

- 説明
  - 前提条件
    - PoPDesicionがtrueの時、呼ばれる。
  - トリガー
    - モグラの状態更新処理で前提条件を満たした時
  - 処理：
    - モグラの状態を出現に変更する。
    - モグラの表示時間を設定する（モグラ表示時間設定関数を用いる）

- 引数
  - void
- 戻り値
  - void

#### モグラ表示時間設定関数

- 説明
  - モグラの出現時・撃退時の表示時間を設定する関数
- 処理：
  - 入力された残り制限時間によって、出力されるモグラの表示時間を少なくする。
- 引数：
  - uint8_t 残り制限時間
- 戻り値
  - uint8_t モグラの表示時間

#### ~~DoNothing~~

- 説明
  - 前提条件：
    - モグラの状態が「出現中」、「撃退」の場合に呼ばれる関数
  - 処理：
    - モグラ表示時間を減少させる。

#### BackToHole

- 説明
  - 前提条件：
    - モグラの状態が「出現中」、「撃退」の場合にのみ呼ばれる。
  - 呼ばれるトリガー：
    - モグラ表示時間が0になった場合
  - 処理：
    - モグラの状態を「穴」に変更する。

#### Attacked

- 説明
  - モグラが撃退された

  - 前提条件
    - モグラの状態が「出現中」の場合にのみ
  - 呼ばれるトリガー
    - 前提条件の時、対応したスイッチが押されていることを検知した
  - 処理
    - モグラの状態を「撃退」へ変更
    - スコアを増加させる

### Timer

#### Penalty

- 説明
  - お手付き処理
- 前提条件
  - モグラの状態が「穴」の時
- 呼ばれるトリガー
  - 前提条件の時、対応したスイッチが押されていることを検知した
- 処理
  - 残り制限時間を3秒減少させる。

### Score

#### IncScore

- 説明
  - スコアを増加させる
- 前提条件
  - モグラの状態が「出現中」の場合にのみ
- 呼ばれるトリガー
  - Attackedが呼ばれた時
- 処理
  - スコアを1増加させる

#### SaveHighScore

- 説明
  - ハイスコアを記録する
- 前提条件
  - システム状態が「ゲーム後」
- 呼ばれるトリガー
  - 前提条件の時、スコアがハイスコアより高い場合
- 処理
  - EEPROMにハイスコアを格納する

#### ClearHighScore

- 説明
  - ハイスコアをクリアする
- 前提条件
  - システム状態が「ゲーム前」、画面状態が「HSクリア確認画面」の時
- 呼ばれるトリガー
  - スイッチ1が入力された
- 処理
  - 選択された難易度に合わせたハイスコアの値として0をEEPROMに書きこむ。

- 引数
  - 難易度
- 戻り値

### Level

#### SetLevel

- 説明
  - 難易度を設定する
- 前提条件
  - システム状態が「ゲーム前」の時
  - 画面状態が「難易度選択画面」の時
- 呼ばれるトリガー
  - スイッチ1 → Easy
  - スイッチ2 → Normal
  - スイッチ3 → Hard
- 処理
  - 難易度を変更
  - 難易度の画面をバッファへ書き込み（WriteToBuffer）

### State

#### ChangeState関数

- 説明
  - システム全体の状態を変更する
  - 状態が変わる時に、呼ばれる
- 引数
  - 状態_全体
- 戻り値
  - void

### LCD

- 説明
  - LCDの画面は、各システムの状態に合わせて、一定間隔でバッファを書き込み、更新する。
  - ゲーム前の画面更新間隔
    - 100ms（10fps）
  - ゲーム中の画面更新間隔
    - 50ms（20fps）

#### ~~WindowManager~~

- 説明
  - 各画面状態ごとのフォーマットに合わせて、バッファに書き込む
  - 画面更新の間隔を制御する
- 前提条件
  - 各システム状態ごとの画面更新間隔の時間が経つ（フラグが経つ）
- 呼ばれるトリガー
  - 各システム状態の最後の処理
- 処理
  - 画面状態に合わせて、必要な値を取得し、フォーマットを作成する。
  - 各画面状態ごとにフォーマット通りにバッファに文字列を書き込む。（WriteToBuffer）

#### WriteToBuffer

- 説明
  - バッファに文字列を書きこむ。
  - バッファに書き込み、フラグを立たせる。
- 前提条件
  - なし
- 呼ばれるトリガー
  - なし
- 処理
  - 引数
    - 書き込む文字列
  - 戻り値
    - エラー値

#### BufferToLCD

- 説明
  - バッファに書き込み、フラグが立った時のみ、LCDへバッファを書き込む。
  - 書き込んだら、フラグを下げる。
- 前提条件
  - アップデートフラグが立っている時
- 呼ばれるトリガー
  - メインの最後に呼ばれる。
- 処理
  - バッファをLCDへ書き込む。

### Buzzer

- 説明
  - BGMと効果音の2種類がある。
    - BGM
      - システム状態がゲーム中の時、常時曲をループ再生させる。
    - 効果音
      - ゲームが始まる時やモグラを叩いた時など、あるタイミングで決まったパターンのメロディを再生する。あるタイミングは仕様書の概要シートに記載。
      - BGMが流れていた場合、BGMを消音し、効果音を再生した後、再生した分の長さが経過した地点からBGMを再生する。
      - 効果音が鳴っている最中に再度PlaySEが呼ばれた時、一度効果音を停止し、呼ばれた効果音を最初から再生する。

#### PlayBGM

- 説明
  - BGMを再生する。
  - 鳴動パターンは予め設定する。
- 前提条件
  - BGMが再生されていない。
- 呼ばれるトリガー
  - ゲーム開始時
- 処理
  - PWMを開始し、BGMを最初から再生させる。
  - 楽譜に合わせて、PWMをONにする長さとタイマ間隔を変更する。

#### StopBGM

- 説明
  - BGMを止める
- 前提条件
  - BGMが再生されている。
- 呼ばれるトリガー
  - ゲーム終了時
- 処理
  - PWMを停止させる。

#### PlaySE

- 説明
  - 効果音を再生する
  - 再生パターンは予め設定する
- 前提条件
  - なし
- 呼ばれるトリガー
  - 再生するタイミングの詳細は仕様書の概要シートに記載
- 処理
  - PWMを開始し、効果音を最初から再生する。
  - 引数
    - 鳴らす効果音の番号（uint8_t）
  - 戻り値
    - void

#### StopSE

- 説明
  - 効果音を停止させる。
- 前提条件
  - 効果音が再生している時
- 呼ばれるトリガー
  - 効果音が最後まで再生された時
- 処理
  - 効果音を止める。

### LED

#### UpdateLDE

- 説明
  - 残り制限時間をLEDで表現する。
- 前提条件
  - 画面状態が「ゲーム中」の時
- 呼ばれるトリガー
  - ゲーム中状態の最後
- 処理
  - 入力された残り制限時間に合わせて、LEDの点灯数を変更する。
  - 引数
    - 残り制限時間
  - 戻り値
    - void

### 乱数発生関数

#### GetRand(void)

- 説明
  - 符号なし16bit乱数を生成する。
  - アルゴリズムはxorshiftを用いる。
- 呼ばれるトリガー
  - モグラの出現判定関数
  - モグラの表示時間
- 引数
  - なし
- 戻り値
  - uint16_t の符号なし16bit整数値
    - 0x0000 ~ 0xFFFF

#### SetRandSeed(uint16_t i_seedX, uint16_t i_seedY)

- 説明
  - GetRand()のシード値を設定する。
- 呼ばれるトリガー
  - ゲーム開始前
  - ゲーム中
    - タイミングは要調整
- 引数
  - uint16_t i_seedX, i_seedY
    - 符号なし16bit整数
    - これらを基にシード値とする。
- 戻り値
  - なし

#### GetRandSeedX(), GetRandSeedY()

- 説明
  - GetRand()で使用するシード値をEEPROMに保存するために使用
  - seedX、seedYそれぞれ返す関数を用意
- 呼ばれるトリガー
  - ゲーム開始時
  - ゲーム終了後
- 引数
  - なし
- 戻り値
  - uint16_t
    - 符号なし16bit整数

## Interrupt

- 10msタイマを使用
- 割込み内でチャタリングを行う。

### Input

#### SW入力

- 説明
  - ポーリングで、すべてのポートからスイッチの状態を取得する。
  - エッジ検知する。

- 使用する変数
  - SWChattaState_type SWChattaState
    - 説明
      - 割込み内にて、静的なローカル変数として定義する。
      - チャタ結果を、メインでグローバル変数で保持している変数に格納する。
    - bool 取得値
    - bool 前回の取得値
    - bool チャタリング処理回数

  - uint8_t SWState
    - 説明
      - 5bitで5つのSWの状態を表現する
      - メイン関数にて、グローバル変数として定義する。
      - 割込み内でチャタ処理をしたスイッチ入力を保持する変数。

### モグラ出現判定フラグ

- 説明：100msごとなどで、フラグを立てて、メイン関数で判定を行う
  - 使用箇所
    - ゲーム中

### カウントダウン用タイマ

- 説明
  - カウントダウン用に1sが必要
  - 1sのタイミングで、制限時間カウントダウン関数を呼ぶ。

### Interrupt_Timer

#### CountDown

- 説明
  - 制限時間カウントダウン関数。
- 前提条件
  - 状態がゲーム開始カウントダウン中、またはゲーム中。
  - タイマ割り込み内で呼ばれる。
- 呼ばれるトリガー
  - カウントダウン用タイマが1sのタイミング
- 処理
  - 制限時間を1減少する。
